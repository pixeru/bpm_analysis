{% extends 'base.html' %}

{% block title %}BPM Analyzer - Upload Audio{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="upload-zone animate-fade-in" id="uploadZone">
            <div class="file-icon">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            <h3 class="mb-3">Upload Audio File</h3>
            <p class="text-muted mb-4">
                Drag and drop your audio file here, or click to browse
            </p>
            <form id="uploadForm" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="file" id="fileInput" name="audio_file" accept=".wav,.mp3,.m4a,.flac,.ogg" hidden>
                <button type="button" class="btn btn-primary btn-lg" id="browseButton">
                    <i class="fas fa-folder-open me-2"></i>
                    Browse Files
                </button>
            </form>
            <div class="mt-3">
                <small class="text-muted">
                    Supported formats: WAV, MP3, M4A, FLAC, OGG | Max size: 100MB
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Progress Section -->
<div class="row mt-4" id="progressSection" style="display: none;">
    <div class="col-12">
        <div class="result-section animate-fade-in">
            <h5 class="mb-3">
                <i class="fas fa-cog fa-spin me-2"></i>
                Processing Audio File
            </h5>
            <div class="progress mb-3" style="height: 20px;">
                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                     role="progressbar" style="width: 0%" id="progressBar">
                    <span id="progressText">0%</span>
                </div>
            </div>
            <div class="text-center">
                <div class="loader mb-3"></div>
                <p class="text-muted mb-0" id="statusText">Uploading file...</p>
            </div>
        </div>
    </div>
</div>

<!-- File Info Section -->
<div class="row mt-4" id="fileInfoSection" style="display: none;">
    <div class="col-12">
        <div class="result-section animate-fade-in">
            <h5 class="mb-3">
                <i class="fas fa-info-circle me-2"></i>
                File Information
            </h5>
            <div class="row">
                <div class="col-md-6">
                    <p><strong>File Name:</strong> <span id="fileName"></span></p>
                    <p><strong>File Size:</strong> <span id="fileSize"></span></p>
                </div>
                <div class="col-md-6">
                    <p><strong>File Type:</strong> <span id="fileType"></span></p>
                    <p><strong>Status:</strong> <span id="fileStatus" class="badge bg-info">Processing</span></p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Error Section -->
<div class="row mt-4" id="errorSection" style="display: none;">
    <div class="col-12">
        <div class="alert alert-danger animate-fade-in" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Error:</strong> <span id="errorMessage"></span>
        </div>
    </div>
</div>

<!-- Sample File Section -->
<div class="row mt-4">
    <div class="col-12">
        <div class="result-section animate-fade-in">
            <h5 class="mb-3">
                <i class="fas fa-music me-2"></i>
                Try Sample File
            </h5>
            <p class="text-muted mb-3">
                Don't have an audio file? Try our sample file to see how the BPM analyzer works.
            </p>
            <button class="btn btn-outline-primary" id="sampleButton">
                <i class="fas fa-play me-2"></i>
                Analyze Sample File
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    const uploadZone = $('#uploadZone');
    const fileInput = $('#fileInput');
    const browseButton = $('#browseButton');
    const uploadForm = $('#uploadForm');
    const progressSection = $('#progressSection');
    const progressBar = $('#progressBar');
    const progressText = $('#progressText');
    const statusText = $('#statusText');
    const fileInfoSection = $('#fileInfoSection');
    const errorSection = $('#errorSection');
    const sampleButton = $('#sampleButton');

    // Browse button click
    browseButton.click(function() {
        fileInput.click();
    });

    // File input change
    fileInput.change(function() {
        const file = this.files[0];
        if (file) {
            processFile(file);
        }
    });

    // Drag and drop functionality
    uploadZone.on('dragover', function(e) {
        e.preventDefault();
        uploadZone.addClass('dragover');
    });

    uploadZone.on('dragleave', function(e) {
        e.preventDefault();
        uploadZone.removeClass('dragover');
    });

    uploadZone.on('drop', function(e) {
        e.preventDefault();
        uploadZone.removeClass('dragover');
        const files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            const file = files[0];
            fileInput[0].files = files;
            processFile(file);
        }
    });

    // Click on upload zone
    uploadZone.click(function() {
        fileInput.click();
    });

    // Sample button click
    sampleButton.click(function() {
        analyzeSampleFile();
    });

    function processFile(file) {
        // Validate file type
        const allowedTypes = ['audio/wav', 'audio/mpeg', 'audio/mp4', 'audio/flac', 'audio/ogg'];
        const allowedExtensions = ['.wav', '.mp3', '.m4a', '.flac', '.ogg'];
        const fileName = file.name.toLowerCase();
        const isValidType = allowedTypes.includes(file.type) || 
                           allowedExtensions.some(ext => fileName.endsWith(ext));

        if (!isValidType) {
            showError('Please select a valid audio file (WAV, MP3, M4A, FLAC, OGG)');
            return;
        }

        // Validate file size (100MB limit)
        const maxSize = 100 * 1024 * 1024; // 100MB in bytes
        if (file.size > maxSize) {
            showError('File size must be less than 100MB');
            return;
        }

        // Show file info
        showFileInfo(file);

        // Start upload
        uploadFile(file);
    }

    function showFileInfo(file) {
        $('#fileName').text(file.name);
        $('#fileSize').text(formatFileSize(file.size));
        $('#fileType').text(file.type || 'Unknown');
        $('#fileStatus').text('Processing').removeClass().addClass('badge bg-info');
        fileInfoSection.show();
    }

    function uploadFile(file) {
        const formData = new FormData();
        formData.append('audio_file', file);
        formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());

        // Show progress
        progressSection.show();
        errorSection.hide();
        
        // Simulate progress for better UX
        let progress = 0;
        const progressInterval = setInterval(function() {
            progress += Math.random() * 10;
            if (progress < 90) {
                updateProgress(progress, 'Uploading and processing...');
            }
        }, 500);

        $.ajax({
            url: '{% url "analyzer:upload" %}',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response) {
                clearInterval(progressInterval);
                updateProgress(100, 'Analysis complete!');
                $('#fileStatus').text('Complete').removeClass().addClass('badge bg-success');
                
                setTimeout(function() {
                    window.location.href = '{% url "analyzer:result" 0 %}'.replace('0', response.analysis_id);
                }, 1000);
            },
            error: function(xhr) {
                clearInterval(progressInterval);
                progressSection.hide();
                
                let errorMsg = 'An error occurred during upload';
                if (xhr.responseJSON && xhr.responseJSON.error) {
                    errorMsg = xhr.responseJSON.error;
                }
                showError(errorMsg);
                $('#fileStatus').text('Error').removeClass().addClass('badge bg-danger');
            }
        });
    }

    function analyzeSampleFile() {
        // Show progress
        progressSection.show();
        errorSection.hide();
        fileInfoSection.hide();
        
        updateProgress(50, 'Loading sample file...');
        
        // Simulate sample file processing
        setTimeout(function() {
            const formData = new FormData();
            formData.append('sample_file', 'true');
            formData.append('csrfmiddlewaretoken', $('[name=csrfmiddlewaretoken]').val());
            
            $.ajax({
                url: '{% url "analyzer:upload" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    updateProgress(100, 'Sample analysis complete!');
                    setTimeout(function() {
                        window.location.href = '{% url "analyzer:result" 0 %}'.replace('0', response.analysis_id);
                    }, 1000);
                },
                error: function(xhr) {
                    progressSection.hide();
                    let errorMsg = 'Sample file analysis failed';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMsg = xhr.responseJSON.error;
                    }
                    showError(errorMsg);
                }
            });
        }, 1000);
    }

    function updateProgress(percent, message) {
        progressBar.css('width', percent + '%');
        progressText.text(Math.round(percent) + '%');
        statusText.text(message);
    }

    function showError(message) {
        $('#errorMessage').text(message);
        errorSection.show();
        progressSection.hide();
    }

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
});
</script>
{% endblock %}